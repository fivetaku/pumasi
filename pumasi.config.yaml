pumasi:
  defaults:
    command: "codex exec --dangerously-bypass-approvals-and-sandbox --skip-git-repo-check"
    emoji: "ğŸ¤–"

  # ì˜ˆì‹œ: ì¸ì¦ ì‹œìŠ¤í…œ (ì‹œê·¸ë‹ˆì²˜ + ìš”êµ¬ì‚¬í•­ íŒ¨í„´)
  # ì‹¤ì œ ì‚¬ìš© ì‹œ ì´ tasks ì„¹ì…˜ì„ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”.
  tasks:
    - name: auth-token
      instruction: |
        src/auth/token.tsë¥¼ êµ¬í˜„í•˜ì„¸ìš”.

        ## ì‹œê·¸ë‹ˆì²˜
        export function generateToken(userId: string, role: 'admin' | 'user'): string
        export function verifyToken(token: string): { userId: string; role: string } | null

        ## ìš”êµ¬ì‚¬í•­
        - jsonwebtoken ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© (ë‹¤ë¥¸ JWT ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© ê¸ˆì§€)
        - í•„ìˆ˜ import: import jwt from 'jsonwebtoken'
        - ë§Œë£Œ ì‹œê°„: 7ì¼
        - secret: process.env.JWT_SECRET
        - verifyTokenì€ ë§Œë£Œ/ë¬´íš¨ í† í°ì— null ë°˜í™˜ (throw ê¸ˆì§€)

        ## ì œì•½ì‚¬í•­
        - TypeScript strict mode
        - ESM (import/export)

      gates:
        - name: "íŒŒì¼ ì¡´ì¬"
          command: "[ -f src/auth/token.ts ]"
        - name: "íƒ€ì… ì²´í¬"
          command: "npx tsc --noEmit src/auth/token.ts"
        - name: "jsonwebtoken ì‚¬ìš©"
          command: "grep -q 'jsonwebtoken' src/auth/token.ts"
        - name: "ì‹œê·¸ë‹ˆì²˜ í™•ì¸"
          command: "grep -q 'generateToken' src/auth/token.ts && grep -q 'verifyToken' src/auth/token.ts"

    - name: auth-password
      instruction: |
        src/auth/password.tsë¥¼ êµ¬í˜„í•˜ì„¸ìš”.

        ## ì‹œê·¸ë‹ˆì²˜
        export function hashPassword(plain: string): Promise<string>
        export function comparePassword(plain: string, hash: string): Promise<boolean>

        ## ìš”êµ¬ì‚¬í•­
        - bcrypt ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© (ë‹¤ë¥¸ í•´ì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬ ê¸ˆì§€)
        - í•„ìˆ˜ import: import bcrypt from 'bcrypt'
        - salt rounds: 12
        - hashPasswordëŠ” bcrypt.hashë¡œ í•´ì‹±
        - comparePasswordëŠ” bcrypt.compareë¡œ ë¹„êµ

        ## ì œì•½ì‚¬í•­
        - TypeScript strict mode
        - ESM (import/export)
        - async/await ì‚¬ìš©

      gates:
        - name: "íŒŒì¼ ì¡´ì¬"
          command: "[ -f src/auth/password.ts ]"
        - name: "íƒ€ì… ì²´í¬"
          command: "npx tsc --noEmit src/auth/password.ts"
        - name: "bcrypt ì‚¬ìš©"
          command: "grep -q 'bcrypt' src/auth/password.ts"
        - name: "ì‹œê·¸ë‹ˆì²˜ í™•ì¸"
          command: "grep -q 'hashPassword' src/auth/password.ts && grep -q 'comparePassword' src/auth/password.ts"

    - name: user-model
      instruction: |
        src/models/user.tsë¥¼ êµ¬í˜„í•˜ì„¸ìš”.

        ## íƒ€ì… ì •ì˜
        interface User {
          id: string
          email: string
          passwordHash: string
          role: 'admin' | 'user'
          createdAt: string
          updatedAt: string
        }

        ## ì‹œê·¸ë‹ˆì²˜
        export function createUser(email: string, passwordHash: string, role?: 'admin' | 'user'): User
        export function findUserByEmail(email: string): User | null
        export function findUserById(id: string): User | null

        ## ìš”êµ¬ì‚¬í•­
        - better-sqlite3ë¡œ SQLite DB ì‚¬ìš© (JSON íŒŒì¼/fs ì‚¬ìš© ì ˆëŒ€ ê¸ˆì§€)
        - í•„ìˆ˜ import: import Database from 'better-sqlite3'
        - DB íŒŒì¼ ê²½ë¡œ: ./data/users.db
        - idëŠ” crypto.randomUUID()ë¡œ ìƒì„±
        - users í…Œì´ë¸” ìë™ ìƒì„± (CREATE TABLE IF NOT EXISTS)
        - createdAt/updatedAtì€ ISO 8601 ë¬¸ìì—´

        ## ì œì•½ì‚¬í•­
        - TypeScript strict mode
        - ESM (import/export)

      gates:
        - name: "íŒŒì¼ ì¡´ì¬"
          command: "[ -f src/models/user.ts ]"
        - name: "íƒ€ì… ì²´í¬"
          command: "npx tsc --noEmit src/models/user.ts"
        - name: "better-sqlite3 ì‚¬ìš©"
          command: "grep -q 'better-sqlite3' src/models/user.ts && ! grep -q 'readFileSync' src/models/user.ts"
        - name: "ì‹œê·¸ë‹ˆì²˜ í™•ì¸"
          command: "grep -q 'createUser' src/models/user.ts && grep -q 'findUserByEmail' src/models/user.ts"

  settings:
    timeout: 3600
